<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guardiões ERP - Qualidade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: sans-serif; }
    .hidden { display: none !important; }
    .kpi-card { background: white; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .kpi-card.active { border-color: #0d6efd; background-color: #f0f7ff; }
    .kpi-number { font-size: 2rem; font-weight: bold; }
    .list-item-card { background: white; border-left: 5px solid #dee2e6; border-radius: 8px; margin-bottom: 10px; padding: 15px; cursor: pointer; }
    .status-Aberto { border-left-color: #dc3545; }
    .status-Aguardando { border-left-color: #ffc107; }
    .custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .modal-card { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; }
    .btn-evidence { display: block; background: #eef6ff; padding: 10px; margin-top: 5px; border-radius: 5px; text-decoration: none; color: #0d6efd; font-weight: bold; text-align: center; }
  </style>
</head>
<body>

  <div id="view-login" class="container mt-5" style="max-width: 400px;">
    <div class="card p-4 shadow">
      <h3 class="text-center text-primary fw-bold mb-4">Guardiões</h3>
      <input type="text" id="loginUser" class="form-control mb-2" placeholder="Usuário">
      <input type="password" id="loginPass" class="form-control mb-3" placeholder="Senha">
      <button onclick="doLogin()" id="btnLogin" class="btn btn-primary w-100">ENTRAR</button>
    </div>
  </div>

  <div id="view-dashboard" class="hidden">
    <nav class="navbar navbar-dark bg-primary mb-4"><div class="container"><span class="navbar-brand">ERP QUALIDADE</span></div></nav>
    <div class="container">
      <div class="row g-2 mb-4">
        <div class="col-4"><div class="kpi-card" onclick="filterData('Aberto', this)"><div id="kpiOpen" class="kpi-number text-danger">0</div><div class="small fw-bold">ABERTOS</div></div></div>
        <div class="col-4"><div class="kpi-card" onclick="filterData('Aguardando', this)"><div id="kpiWait" class="kpi-number text-warning">0</div><div class="small fw-bold">VALIDAR</div></div></div>
        <div class="col-4"><div class="kpi-card" onclick="filterData('Fechado', this)"><div id="kpiClosed" class="kpi-number text-success">0</div><div class="small fw-bold">FECHADOS</div></div></div>
      </div>
      <div id="listContainer"></div>
    </div>
    <button onclick="openNewForm()" class="btn btn-primary shadow" style="position:fixed; bottom:20px; right:20px; border-radius:50%; width:60px; height:60px; font-size:24px;">+</button>
  </div>

  <div id="modalDetails" class="custom-modal hidden">
    <div class="modal-card">
      <h5 class="fw-bold mb-3">Detalhes do Registro</h5>
      <div id="detContent" class="small mb-3"></div>
      <div id="detGallery"></div>
      <button onclick="closeModal()" class="btn btn-secondary w-100 mt-3">Fechar</button>
    </div>
  </div>

  <script>
    const API_URL = "SUA_URL_DO_GOOGLE_SCRIPT_AQUI"; //
    let currUser = null, allData = [], bufferImages = [];

    async function callBackend(action, payload = {}) {
      const url = `${API_URL}?action=${action}&payload=${encodeURIComponent(JSON.stringify(payload))}&userJson=${encodeURIComponent(JSON.stringify(currUser))}`;
      if (action === 'saveRisk') {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action, payload, userJson: JSON.stringify(currUser) }) });
        return { status: 'success' };
      }
      const res = await fetch(url);
      return await res.json();
    }

    async function doLogin() {
      const u = document.getElementById('loginUser').value;
      const p = document.getElementById('loginPass').value;
      const res = await callBackend('login', { login: u, password: p });
      if(res.status === 'success') { currUser = res; loadDash(); } else { alert("Erro login"); }
    }

    async function loadDash() {
      document.getElementById('view-login').classList.add('hidden');
      document.getElementById('view-dashboard').classList.remove('hidden');
      const data = await callBackend('getDashboard');
      allData = [...data.pending, ...data.history];
      document.getElementById('kpiOpen').innerText = data.stats.open;
      document.getElementById('kpiWait').innerText = data.stats.wait;
      document.getElementById('kpiClosed').innerText = data.stats.closed;
      renderList(allData);
    }

    function renderList(items) {
      const container = document.getElementById('listContainer');
      container.innerHTML = '';
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = `list-item-card status-${item.status.split(' ')[0]}`;
        div.onclick = () => showDetails(item);
        div.innerHTML = `<div class="fw-bold">PN: ${item.pn}</div><div class="small text-muted">${item.desc}</div>`;
        container.appendChild(div);
      });
    }

    function showDetails(item) {
      document.getElementById('detContent').innerHTML = `<b>Status:</b> ${item.status}<br><b>PN:</b> ${item.pn}<br><b>Desc:</b> ${item.desc}`;
      const gallery = document.getElementById('detGallery');
      gallery.innerHTML = '<h6 class="fw-bold mt-2">Evidências:</h6>';
      if(item.photosOpen) {
        item.photosOpen.split(',').forEach((link, i) => {
          gallery.innerHTML += `<a href="${link}" target="_blank" class="btn-evidence">Ver Foto ${i+1}</a>`;
        });
      } else { gallery.innerHTML += '<p class="small text-muted">Sem anexos.</p>'; }
      document.getElementById('modalDetails').classList.remove('hidden');
    }

    function filterData(status, el) {
      document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      renderList(allData.filter(i => i.status.includes(status)));
    }

    function closeModal() { document.getElementById('modalDetails').classList.add('hidden'); }
  </script>
</body>
</html>
