<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; padding: 20px; }
    .card { max-width: 600px; margin: auto; padding: 20px; border-radius: 15px; }
    .hidden { display: none; }
    .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <div id="login-box" class="card shadow">
    <h3>ERP Riscos - Login</h3>
    <input type="text" id="user" class="form-control mb-2" placeholder="Usuário">
    <input type="password" id="pass" class="form-control mb-3" placeholder="Senha">
    <button onclick="login()" class="btn btn-primary w-100">Entrar</button>
    <button onclick="showReg()" class="btn btn-link w-100">Criar conta</button>
  </div>

  <div id="main-app" class="hidden">
    <div class="d-flex justify-content-between mb-4">
      <h4 id="user-title">Painel</h4>
      <button onclick="location.reload()" class="btn btn-outline-danger btn-sm">Sair</button>
    </div>
    
    <div id="adm-view" class="hidden">
      <h5>Aprovações Pendentes</h5>
      <div id="pending-list"></div>
    </div>

    <div id="user-view" class="hidden">
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#abrir">Abrir Risco</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tarefas" onclick="loadTasks()">Minhas Tarefas</a></li>
      </ul>
      <div class="tab-content">
        <div id="abrir" class="tab-pane active">
          <input type="text" id="f-pn" class="form-control mb-2" placeholder="PN">
          <input type="text" id="f-oc" class="form-control mb-2" placeholder="OC">
          <input type="text" id="f-target" class="form-control mb-2" placeholder="Quem trata?">
          <textarea id="f-desc" class="form-control mb-2" placeholder="Descrição"></textarea>
          <button onclick="send()" class="btn btn-danger w-100">Submeter</button>
        </div>
        <div id="tarefas" class="tab-pane">
          <div id="task-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let session = {};
    function login() {
      const u = document.getElementById('user').value;
      const p = document.getElementById('pass').value;
      google.script.run.withSuccessHandler(res => {
        if(res.status === "success") {
          session = res;
          document.getElementById('login-box').classList.add('hidden');
          document.getElementById('main-app').classList.remove('hidden');
          if(res.role === "ADM") {
            document.getElementById('adm-view').classList.remove('hidden');
            loadAdmin();
          } else {
            document.getElementById('user-view').classList.remove('hidden');
          }
        } else { alert(res.message); }
      }).realizarLogin(u, p);
    }

    function loadTasks() {
      google.script.run.withSuccessHandler(data => {
        let h = "";
        data.forEach(r => {
          h += `<div class="card mb-2 p-2">
            <b>${r[4]} - ${r[7]}</b><br>${r[6]}<br>
            ${r[3]===session.nome && r[7]==='Aberto' ? `<input id="act-${r[0]}" class="form-control mb-1"><button onclick="treat('${r[0]}')" class="btn btn-sm btn-warning">Enviar Tratativa</button>` : ''}
            ${r[2]===session.nome && r[7]==='Em Validação' ? `<button onclick="closeR('${r[0]}')" class="btn btn-sm btn-success">Aprovar e Fechar</button>` : ''}
          </div>`;
        });
        document.getElementById('task-list').innerHTML = h || "Nada encontrado.";
      }).listarMeusChamados(session.nome);
    }
    // Funções complementares de treat e closeR omitidas para brevidade, mas seguem o padrão google.script.run
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
