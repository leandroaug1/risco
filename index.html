<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f4f7f6; font-family: sans-serif; }
    .card-login { max-width: 400px; margin: 80px auto; border-radius: 15px; }
    .hidden { display: none; }
    .btn-primary { background-color: #0056b3; }
  </style>
</head>
<body>
<div class="container">

  <div id="box-login" class="card card-login shadow p-4">
    <h3 class="text-center mb-4">ERP Riscos</h3>
    <input type="text" id="user" class="form-control mb-3" placeholder="Usuário">
    <input type="password" id="pass" class="form-control mb-3" placeholder="Senha">
    <button onclick="fazerLogin()" class="btn btn-primary w-100">Entrar</button>
    <button onclick="abrirCadastro()" class="btn btn-link w-100 mt-2">Criar conta</button>
  </div>

  <div id="box-cadastro" class="card card-login shadow p-4 hidden">
    <h4 class="mb-3">Solicitar Acesso</h4>
    <input type="text" id="reg-nome" class="form-control mb-2" placeholder="Nome Completo">
    <input type="text" id="reg-login" class="form-control mb-2" placeholder="Login desejado">
    <input type="password" id="reg-pass" class="form-control mb-2" placeholder="Senha">
    <input type="text" id="reg-dep" class="form-control mb-3" placeholder="Departamento">
    <button onclick="salvarUsuario()" class="btn btn-success w-100">Enviar para Aprovação</button>
    <button onclick="location.reload()" class="btn btn-light w-100 mt-2">Voltar</button>
  </div>

  <div id="box-adm" class="mt-5 hidden">
    <div class="d-flex justify-content-between">
      <h2>Painel Administrativo</h2>
      <button onclick="location.reload()" class="btn btn-outline-danger">Sair</button>
    </div>
    <div id="lista-pendentes" class="mt-4 row"></div>
  </div>

  <div id="box-user" class="mt-5 hidden">
    <div class="card p-4 shadow">
      <h3>Novo Apontamento de Risco</h3>
      <p class="text-muted">Preencha os dados abaixo para notificar o Guardião da Tratativa.</p>
      <div class="row">
        <div class="col-md-6 mb-2"><input type="text" id="pn" class="form-control" placeholder="PN (Part Number)"></div>
        <div class="col-md-6 mb-2"><input type="text" id="oc" class="form-control" placeholder="OC (Ordem de Compra)"></div>
        <div class="col-12 mb-2"><input type="text" id="destino" class="form-control" placeholder="Quem deve tratar? (Nome do Usuário)"></div>
        <div class="col-12 mb-3"><textarea id="desc" class="form-control" rows="4" placeholder="Descrição detalhada do risco"></textarea></div>
      </div>
      <button onclick="enviarChamado()" class="btn btn-danger btn-lg">Submeter Risco</button>
    </div>
  </div>

</div>

<script>
  let session = {};

  function fazerLogin() {
    const u = document.getElementById('user').value;
    const p = document.getElementById('pass').value;
    google.script.run.withSuccessHandler(res => {
      if(res.status === "success") {
        session = res;
        document.getElementById('box-login').classList.add('hidden');
        if(res.role === "ADM") {
          document.getElementById('box-adm').classList.remove('hidden');
          atualizarPendentes();
        } else {
          document.getElementById('box-user').classList.remove('hidden');
        }
      } else { alert(res.message); }
    }).realizarLogin(u, p);
  }

  function abrirCadastro() {
    document.getElementById('box-login').classList.add('hidden');
    document.getElementById('box-cadastro').classList.remove('hidden');
  }

  function salvarUsuario() {
    const obj = {
      nome: document.getElementById('reg-nome').value,
      login: document.getElementById('reg-login').value,
      senha: document.getElementById('reg-pass').value,
      departamento: document.getElementById('reg-dep').value
    };
    google.script.run.withSuccessHandler(msg => {
      alert(msg);
      location.reload();
    }).registrarNovoUsuario(obj);
  }

  function atualizarPendentes() {
    google.script.run.withSuccessHandler(lista => {
      let html = '';
      lista.forEach(u => {
        html += `<div class="col-md-4"><div class="card p-3 mb-2">
          <b>${u[1]}</b><br><small>${u[4]}</small>
          <button onclick="aprovar('${u[0]}')" class="btn btn-sm btn-success mt-2">Aprovar</button>
        </div></div>`;
      });
      document.getElementById('lista-pendentes').innerHTML = html || "Nenhum usuário pendente.";
    }).listarPendentes();
  }

  function aprovar(id) {
    google.script.run.withSuccessHandler(() => atualizarPendentes()).aprovarUsuario(id);
  }

  function enviarChamado() {
    const dados = {
      pn: document.getElementById('pn').value,
      oc: document.getElementById('oc').value,
      descricao: document.getElementById('desc').value,
      destino: document.getElementById('destino').value,
      criador: session.nome
    };
    google.script.run.withSuccessHandler(msg => {
      alert(msg);
      document.getElementById('pn').value = "";
      document.getElementById('oc').value = "";
      document.getElementById('desc').value = "";
    }).enviarRisco(dados);
  }
</script>
</body>
</html>
