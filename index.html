<style>
  .img-container {
    position: relative;
    display: inline-block;
    margin: 5px;
  }
  .img-evidence {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid #ddd;
    transition: 0.3s;
  }
  .img-evidence:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  #fileCountBadge {
    display: inline-block;
    background: #0d6efd;
    color: white;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    margin-top: 5px;
  }
</style>

<div class="mb-4">
  <label class="small fw-bold"><i class="fas fa-camera"></i> Evidências (Múltiplas)</label>
  <input type="file" id="fOpen" multiple class="form-control" accept="image/*">
  <div id="fileCountBadge" class="hidden">0 fotos carregadas</div>
</div>

<div id="modalDetails" class="custom-modal hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;">
  <div class="modal-content-card" style="background:white; padding:20px; border-radius:12px; width:90%; max-width:600px; max-height:80vh; overflow-y:auto;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold m-0">Detalhes da Ocorrência</h5>
      <button onclick="closeModal()" class="btn-close"></button>
    </div>
    <div id="detContent"></div>
    <hr>
    <h6 class="fw-bold">Anexos:</h6>
    <div id="detGallery" class="d-flex flex-wrap mt-2"></div>
    <div class="mt-4 text-end">
      <button onclick="closeModal()" class="btn btn-primary">Fechar</button>
    </div>
  </div>
</div>

<script>
  // 1. CORREÇÃO: Buffer acumulativo para fotos infinitas
  let bufferImages = [];
  document.getElementById('fOpen').onchange = (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        bufferImages.push(ev.target.result); // Adiciona ao invés de substituir
        document.getElementById('fileCountBadge').innerText = `${bufferImages.length} fotos carregadas`;
        document.getElementById('fileCountBadge').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });
  };

  // 2. CORREÇÃO: Função para exibir detalhes com galeria de fotos
  function showDetails(item) {
    const content = document.getElementById('detContent');
    const gallery = document.getElementById('detGallery');
    
    content.innerHTML = `
      <p><b>PN:</b> ${item.pn}</p>
      <p><b>Status:</b> ${item.status}</p>
      <p><b>Descrição:</b> ${item.desc}</p>
      <p><b>Solicitado por:</b> ${item.opener}</p>
    `;

    gallery.innerHTML = ''; // Limpa a galeria anterior

    if (item.photosData) {
      try {
        // Tenta converter a string de volta para array se necessário
        const photos = typeof item.photosData === 'string' ? JSON.parse(item.photosData) : item.photosData;
        
        if (photos.length > 0) {
          photos.forEach(base64 => {
            const img = document.createElement('img');
            img.src = base64;
            img.className = 'img-evidence';
            img.onclick = () => {
              // Abre a imagem em tamanho real em uma nova aba
              const win = window.open();
              win.document.write(`<img src="${base64}" style="max-width:100%">`);
            };
            gallery.appendChild(img);
          });
        } else {
          gallery.innerHTML = '<span class="text-muted small">Nenhuma foto anexada.</span>';
        }
      } catch (e) {
        console.error("Erro ao processar imagens:", e);
        gallery.innerHTML = '<span class="text-danger small">Erro ao carregar anexos.</span>';
      }
    } else {
      gallery.innerHTML = '<span class="text-muted small">Sem evidências.</span>';
    }

    document.getElementById('modalDetails').classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('modalDetails').classList.add('hidden');
  }

  // Certifique-se de que no seu renderList() o onclick está chamando showDetails(r)
</script>
